<!DOCTYPE html>
<html lang="japanese">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>JeVois Tutorial(2) - JeVoisでOpenCVのコーナー検出(C++)を実行</title>

        <!-- Bootstrap Core CSS -->
        <link href="./theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="./theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="./theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="サンプルコードではOpenCVが使用されていませんでしたが、jevois-sdkをインストールする際にOpenCV(4.0)パッケージも一緒にインストールされています。OpenCVの画像処理モジュールはそのまま使えますが、jevoisのモジュールから取得した画像をOpenC...">

        <meta name="author" content="Kousuke Takeuchi">

        <meta name="tags" content="エッジコンピューティング">
        <meta name="tags" content="画像処理">
        <meta name="tags" content="JeVois">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Whitepaper Tech Blog">

	<meta property="og:type" content="article">
            <meta property="article:author" content="./author/kousuke-takeuchi.html">
	<meta property="og:url" content="./JeVois-Tutorial-2.html">
	<meta property="og:title" content="JeVois Tutorial(2) - JeVoisでOpenCVのコーナー検出(C++)を実行">
	<meta property="article:published_time" content="2020-01-09 00:00:00+09:00">
            <meta property="og:description" content="サンプルコードではOpenCVが使用されていませんでしたが、jevois-sdkをインストールする際にOpenCV(4.0)パッケージも一緒にインストールされています。OpenCVの画像処理モジュールはそのまま使えますが、jevoisのモジュールから取得した画像をOpenC...">

                <meta property="og:image" content="https://tech.wpaper-inc.com/images/20200106_JeVois_tg2e9bgo.jpg">
    <link rel="icon" href="/favicon.ico">
</head>

<body class="article-JeVois-Tutorial-2">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="./">Whitepaper Tech Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('./images/20200106_jevois-header.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>JeVois Tutorial(2) - JeVoisでOpenCVのコーナー検出(C++)を実行</h1>
                        <span class="meta">Posted by
                                <a href="./author/kousuke-takeuchi.html">Kousuke Takeuchi</a>
                             on 木 09 1月 2020
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <h2>1. HelloJeVoisのサンプルプログラム</h2>
<p>前回はC++の開発環境を構築しました。その後、カメラ画像に「Hello World」を表示するモジュールを実行しました。</p>
<p>モジュールのプログラム本体は<code>src/Modules/HelloJeVois/HelloJeVois.C</code>です。</p>
<div class="highlight"><pre><span></span> <span class="cp">#include</span> <span class="cpf">&lt;jevois/Core/Module.H&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;jevois/Image/RawImageOps.H&gt;</span><span class="cp"></span>

 <span class="c1">// icon by Catalin Fertu in cinema at flaticon</span>

 <span class="c1">//! JeVois sample module</span>
 <span class="cm">/*! This module is provided as an example of how to create a new standalone module.</span>

<span class="cm">     JeVois provides helper scripts and files to assist you in programming new modules, following two basic formats:</span>

<span class="cm">     - if you wish to only create a single module that will execute a specific function, or a collection of such modules</span>
<span class="cm">       where there is no shared code between the modules (i.e., each module does things that do not relate to the other</span>
<span class="cm">       modules), use the skeleton provided by this sample module. Here, all the code for the sample module is compiled</span>
<span class="cm">       into a single shared object (.so) file that is loaded by the JeVois engine when the corresponding video output</span>
<span class="cm">       format is selected by the host computer.</span>

<span class="cm">     - if you are planning to write a collection of modules with some shared algorithms among several of the modules, it</span>
<span class="cm">       is better to first create machine vision Components that implement the algorithms that are shared among several of</span>
<span class="cm">       your modules. You would then compile all your components into a first shared library (.so) file, and then compile</span>
<span class="cm">       each module into its own shared object (.so) file that depends on and automatically loads your shared library file</span>
<span class="cm">       when it is selected by the host computer. The jevoisbase library and collection of components and modules is an</span>
<span class="cm">       example for how to achieve that, where libjevoisbase.so contains code for Saliency, ObjectRecognition, etc</span>
<span class="cm">       components that are used in several modules, and each module&#39;s .so file contains only the code specific to that</span>
<span class="cm">       module.</span>

<span class="cm">     @author Sample Author</span>

<span class="cm">     @videomapping YUYV 640 480 28.5 YUYV 640 480 28.5 SampleVendor HelloJeVois</span>
<span class="cm">     @email sampleemail\@samplecompany.com</span>
<span class="cm">     @address 123 First Street, Los Angeles, CA 90012</span>
<span class="cm">     @copyright Copyright (C) 2017 by Sample Author</span>
<span class="cm">     @mainurl http://samplecompany.com</span>
<span class="cm">     @supporturl http://samplecompany.com/support</span>
<span class="cm">     @otherurl http://samplecompany.com/about</span>
<span class="cm">     @license GPL v3</span>
<span class="cm">     @distribution Unrestricted</span>
<span class="cm">     @restrictions None */</span>
 <span class="k">class</span> <span class="nc">HelloJeVois</span> <span class="o">:</span> <span class="k">public</span> <span class="n">jevois</span><span class="o">::</span><span class="n">Module</span>
 <span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
     <span class="c1">//! Default base class constructor ok</span>
     <span class="k">using</span> <span class="n">jevois</span><span class="o">::</span><span class="n">Module</span><span class="o">::</span><span class="n">Module</span><span class="p">;</span>

     <span class="c1">//! Virtual destructor for safe inheritance</span>
     <span class="k">virtual</span> <span class="o">~</span><span class="n">HelloJeVois</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

     <span class="c1">//! Processing function</span>
     <span class="k">virtual</span> <span class="kt">void</span> <span class="n">process</span><span class="p">(</span><span class="n">jevois</span><span class="o">::</span><span class="n">InputFrame</span> <span class="o">&amp;&amp;</span> <span class="n">inframe</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">OutputFrame</span> <span class="o">&amp;&amp;</span> <span class="n">outframe</span><span class="p">)</span> <span class="k">override</span>
     <span class="p">{</span>
       <span class="c1">// Wait for next available camera image:</span>
       <span class="n">jevois</span><span class="o">::</span><span class="n">RawImage</span> <span class="k">const</span> <span class="n">inimg</span> <span class="o">=</span> <span class="n">inframe</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

       <span class="c1">// We only support YUYV pixels in this example, any resolution:</span>
       <span class="n">inimg</span><span class="p">.</span><span class="n">require</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">);</span>

       <span class="c1">// Wait for an image from our gadget driver into which we will put our results:</span>
       <span class="n">jevois</span><span class="o">::</span><span class="n">RawImage</span> <span class="n">outimg</span> <span class="o">=</span> <span class="n">outframe</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

       <span class="c1">// Enforce that the input and output formats and image sizes match:</span>
       <span class="n">outimg</span><span class="p">.</span><span class="n">require</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">fmt</span><span class="p">);</span>

       <span class="c1">// Just copy the pixel data over:</span>
       <span class="n">memcpy</span><span class="p">(</span><span class="n">outimg</span><span class="p">.</span><span class="n">pixelsw</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">inimg</span><span class="p">.</span><span class="n">pixels</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">inimg</span><span class="p">.</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">(),</span> <span class="n">outimg</span><span class="p">.</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">()));</span>

       <span class="c1">// Print a text message:</span>
       <span class="n">jevois</span><span class="o">::</span><span class="n">rawimage</span><span class="o">::</span><span class="n">writeText</span><span class="p">(</span><span class="n">outimg</span><span class="p">,</span> <span class="s">&quot;Hello JeVois!&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">yuyv</span><span class="o">::</span><span class="n">White</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">rawimage</span><span class="o">::</span><span class="n">Font20x38</span><span class="p">);</span>

       <span class="c1">// Let camera know we are done processing the input image:</span>
       <span class="n">inframe</span><span class="p">.</span><span class="n">done</span><span class="p">();</span> <span class="c1">// NOTE: optional here, inframe destructor would call it anyway</span>

       <span class="c1">// Send the output image with our processing results to the host over USB:</span>
       <span class="n">outframe</span><span class="p">.</span><span class="n">send</span><span class="p">();</span> <span class="c1">// NOTE: optional here, outframe destructor would call it anyway</span>
     <span class="p">}</span>
 <span class="p">};</span>

 <span class="c1">// Allow the module to be loaded as a shared object (.so) file:</span>
 <span class="n">JEVOIS_REGISTER_MODULE</span><span class="p">(</span><span class="n">HelloJeVois</span><span class="p">);</span>
</pre></div>


<p>不要なコメントを省いて解説すると、プログラムの上から。。。</p>
<p>まずは、jevoisカメラからの画像取得や操作に必要なライブラリをインポートします。</p>
<div class="highlight"><pre><span></span> <span class="cp">#include</span> <span class="cpf">&lt;jevois/Core/Module.H&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;jevois/Image/RawImageOps.H&gt;</span><span class="cp"></span>
</pre></div>


<p>続いて、動画像処理のためのクラスを定義します。定義したクラスを<code>JEVOIS_REGISTER_MODULE(&lt;class_name\&gt;)</code>でJeVoisで登録すると、カメラ画像をこのクラスで定義した関数で処理するようになります。</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HelloJeVois</span> <span class="o">:</span> <span class="k">public</span> <span class="n">jevois</span><span class="o">::</span><span class="n">Module</span>
<span class="p">{</span>
<span class="cp"># ... 関数の定義</span>
<span class="p">}</span>

<span class="n">JEVOIS_REGISTER_MODULE</span><span class="p">(</span><span class="n">HelloJeVois</span><span class="p">);</span>
</pre></div>


<p>HelloJevoisクラスには、3つのpublic関数が定義されています。まずは共有コンストラクター/デコンストラクタです。この二つは特別なセットアップとシャットダウンをしない限りは使用することはなさそうです。</p>
<p>メインで記述するのが、<code>virtual void process</code>です。processには「<code>inframe</code>」と「<code>outframe</code>」が引数で指定されています。<code>inframe</code>には、JeVoisのファームが自動的に撮影した画像を指定してくれて、<code>outframe</code>には、自分で処理した画像を指定する必要があります。</p>
<div class="highlight"><pre><span></span><span class="k">virtual</span> <span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="n">jevois</span><span class="o">::</span><span class="n">InputFrame</span> <span class="o">&amp;&amp;</span> <span class="n">inframe</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">OutputFrame</span> <span class="o">&amp;&amp;</span> <span class="n">outframe</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
  <span class="cp"># ...ここに画像の処理内容を記述</span>
<span class="p">}</span>
</pre></div>


<p>続いて、主に使用するクラスモジュールですが、ここでは<code>jevois::InputFrame</code>, <code>`jevois::InputFrame</code>, <code>jevois::RawImage</code>と<code>jevois::rawimage</code>モジュールになります。</p>
<p><code>InputFrame/OutputFrame</code>は、カメラから動画を取得したり、USB経由で配信する動画を設定するモジュールです。デバイスと画像データの橋渡しをするだけです。</p>
<p>主に操作するのが<code>jevois::RawImage</code>で、InputFrameから取得した画像データになります。OpenCVにおける<code>cv::Mat</code>クラスのようなもので、画像のピクセルデータと、画像のサイズやチャンネルデータを格納するクラスになります。</p>
<p>そして、画像に文字を描画したり操作するモジュールが、<code>jevois::rawimage</code>モジュールになります。いろいろ操作関数が定義されています。</p>
<div class="highlight"><pre><span></span><span class="n">jevois</span><span class="o">::</span><span class="n">RawImage</span> <span class="k">const</span> <span class="n">inimg</span> <span class="o">=</span> <span class="n">inframe</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="n">inimg</span><span class="p">.</span><span class="n">require</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">);</span>

<span class="n">jevois</span><span class="o">::</span><span class="n">RawImage</span> <span class="n">outimg</span> <span class="o">=</span> <span class="n">outframe</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="n">outimg</span><span class="p">.</span><span class="n">require</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">fmt</span><span class="p">);</span>
</pre></div>


<p>まずは、<a href="http://jevois.org/doc/classjevois_1_1InputFrame.html#a3300ed6b18c5b5488cf062a5b45c3b56"><code>InputFrame::get()</code></a>でカメラ画像を取得します。取得した画像は<code>RawImage</code>クラスとして返されます。続いて<a href="http://jevois.org/doc/classjevois_1_1RawImage.html#aacde26c84586c08d1e913694670d2d8e"><code>RawImage::require()</code></a>を呼び出していますが、JeVoisはvideomappingでモジュールに関係なくカメラ画像の解像度やピクセルフォーマットを変更することができるので、モジュール側で制限が必要な場合はrequire関数で制限を設定します。今回は解像度は何でもいいので、inimgのサイズをそのまま使っています。また、ピクセルフォーマットは<code>YUYV</code>を指定します。</p>
<p><code>OutputFrame</code>でも同様に、出力する画像を取得します。ここで、取得しているのは画像配列へのポインタであって、配列にはまだ画像データが設定されていないことに注意してください。このポインタに対して画像を設定することで、USB経由で処理画像が送信されます。</p>
<p>さらに、<code>outimg.require</code>では、ピクセルフォーマットを<code>inimg.fmt</code>に設定しています。入力画像と同じYUYVになるように画像処理をしないといけないです。</p>
<p>続いて、出力画像に処理を加えていきます。</p>
<div class="highlight"><pre><span></span><span class="n">memcpy</span><span class="p">(</span><span class="n">outimg</span><span class="p">.</span><span class="n">pixelsw</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">inimg</span><span class="p">.</span><span class="n">pixels</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">inimg</span><span class="p">.</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">(),</span> <span class="n">outimg</span><span class="p">.</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">()));</span>

<span class="n">jevois</span><span class="o">::</span><span class="n">rawimage</span><span class="o">::</span><span class="n">writeText</span><span class="p">(</span><span class="n">outimg</span><span class="p">,</span> <span class="s">&quot;Hello JeVois!&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">yuyv</span><span class="o">::</span><span class="n">White</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">rawimage</span><span class="o">::</span><span class="n">Font20x38</span><span class="p">);</span>
</pre></div>


<p>まずはmemcopyで、<code>inimg</code>の画像データをそのまま出力画像<code>outimg</code>に設定します。</p>
<p>その後、<code>rawimage::writeText</code>で、<code>outimg</code>に文字を描画します。引数の詳細は<a href="http://jevois.org/doc/group__image.html#ga893e982b449643c8853afe424fb72c09">こちら</a>にありますが、やっていることは描画する座標とフォント、色の設定くらいです。OpenCVほど高機能にはなっていないみたいです。</p>
<p>最後に、<code>inframe.done()</code>と<code>outframe.send()</code>を呼び出します。</p>
<div class="highlight"><pre><span></span><span class="n">inframe</span><span class="p">.</span><span class="n">done</span><span class="p">();</span> <span class="c1">// NOTE: optional here, inframe destructor would call it anyway</span>
<span class="n">outframe</span><span class="p">.</span><span class="n">send</span><span class="p">();</span>
</pre></div>


<p><a href="http://jevois.org/doc/classjevois_1_1InputFrame.html#a3ad6ba7b0e66fefb8e43944ca4e90bcf"><code>InputFrame::done()</code></a>は、カメラ画像のフレーム取得を終了する関数ですが、ドキュメントには<code>InputFrame::get()</code>を呼び出したらすぐにdoneを実行してくれと書いてあります。ただし、コメントにもある通り、呼び出さなくてもデコンストラクタで必ず実行されるらしいです。InFrame::getをしたらすぐにdoneを呼び出すのが賢明そうです。</p>
<p><a href="http://jevois.org/doc/classjevois_1_1OutputFrame.html#ae6dafb6fab88b4166dc4b206c21c56a8"><code>OutputFrame::send()</code></a>でUSB経由で処理画像データの送信を開始します。</p>
<h2>2. OpenCVでコーナー検出</h2>
<p>サンプルコードではOpenCVが使用されていませんでしたが、<code>jevois-sdk</code>をインストールする際にOpenCV(4.0)パッケージも一緒にインストールされています。</p>
<p>OpenCVの画像処理モジュールはそのまま使えますが、jevoisのモジュールから取得した画像をOpenCVで取り扱えるように変換する必要があることに注意しながら、コーナー検出のプログラムを書いていきます。</p>
<p>まずは、opencvのライブラリをインポートして、共通クラスを書いていきます。</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;jevois/Core/Module.H&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;jevois/Image/RawImageOps.H&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">cv</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">    @author Whitepaper</span>

<span class="cm">    @videomapping YUYV 640 480 28.5 YUYV 640 480 28.5 SampleVendor HelloJeVois</span>
<span class="cm">    @copyright Copyright (C) 2020 by Whitepaper</span>
<span class="cm">    @distribution Unrestricted</span>
<span class="cm">    @restrictions None */</span>

<span class="k">class</span> <span class="nc">HelloJeVois</span> <span class="o">:</span> <span class="k">public</span> <span class="n">jevois</span><span class="o">::</span><span class="n">Module</span>
<span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="k">using</span> <span class="n">jevois</span><span class="o">::</span><span class="n">Module</span><span class="o">::</span><span class="n">Module</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">HelloJeVois</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="k">virtual</span> <span class="kt">void</span> <span class="n">process</span><span class="p">(</span><span class="n">jevois</span><span class="o">::</span><span class="n">InputFrame</span> <span class="o">&amp;&amp;</span> <span class="n">inframe</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">OutputFrame</span> <span class="o">&amp;&amp;</span> <span class="n">outframe</span><span class="p">)</span> <span class="k">override</span>
    <span class="p">{</span>
      <span class="n">jevois</span><span class="o">::</span><span class="n">RawImage</span> <span class="k">const</span> <span class="n">inimg</span> <span class="o">=</span> <span class="n">inframe</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
      <span class="n">inimg</span><span class="p">.</span><span class="n">require</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">);</span>

      <span class="n">jevois</span><span class="o">::</span><span class="n">RawImage</span> <span class="n">outimg</span> <span class="o">=</span> <span class="n">outframe</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
      <span class="n">outimg</span><span class="p">.</span><span class="n">require</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">inimg</span><span class="p">.</span><span class="n">fmt</span><span class="p">);</span>

      <span class="cp"># ... ここに検出ロジックを記述</span>

      <span class="n">inframe</span><span class="p">.</span><span class="n">done</span><span class="p">();</span>
      <span class="n">outframe</span><span class="p">.</span><span class="n">send</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">JEVOIS_REGISTER_MODULE</span><span class="p">(</span><span class="n">HelloJeVois</span><span class="p">);</span>
</pre></div>


<p>続いて、jevoisのモジュールから取得した画像を<code>cv::Mat</code>に変換するためには、<a href="http://jevois.org/doc/namespacejevois_1_1rawimage.html"><code>jevois::rawimage::convertToCvBGR()</code></a>を使用します。グレースケールに変換して画像を取得するには、<code>jevois::rawimage::convertToCvGray()</code>を呼び出します。</p>
<p>OpenCVのコーナー検出は、グレースケールの画像を使用するため、以下のように書きます。</p>
<div class="highlight"><pre><span></span><span class="c1">// グレースケールと標準化</span>
<span class="n">Mat</span> <span class="n">grayImg</span> <span class="o">=</span> <span class="n">jevois</span><span class="o">::</span><span class="n">rawimage</span><span class="o">::</span><span class="n">convertToCvGray</span><span class="p">(</span><span class="n">inimg</span><span class="p">);</span>
<span class="n">normalize</span><span class="p">(</span><span class="n">grayImg</span><span class="p">,</span> <span class="n">grayImg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">NORM_MINMAX</span><span class="p">);</span>
</pre></div>


<p>これで、<code>jevois::RawImage</code>を<code>cv::Mat</code>に変換できました。あとはOpenCVでコーナー検出を行います。</p>
<div class="highlight"><pre><span></span><span class="c1">// コーナーの検出</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point2f</span><span class="o">&gt;</span> <span class="n">corners</span><span class="p">;</span>
<span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">grayImg</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">Point2f</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it_corner</span> <span class="o">=</span> <span class="n">corners</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(;</span> <span class="n">it_corner</span><span class="o">!=</span><span class="n">corners</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it_corner</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">jevois</span><span class="o">::</span><span class="n">rawimage</span><span class="o">::</span><span class="n">drawCircle</span><span class="p">(</span><span class="n">outimg</span><span class="p">,</span> <span class="n">it_corner</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">it_corner</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">jevois</span><span class="o">::</span><span class="n">yuyv</span><span class="o">::</span><span class="n">LightGreen</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><code>cv::goodFeaturesToTrack</code>でコーナーを検出し、corners配列に格納しています。最後に検出したコーナーをforループで取り出し、<code>outimg</code>に描画しています。描画は<code>jevois::RawImage</code>にするため、<a href="http://jevois.org/doc/group__image.html#gae7d102e1c456f87337d66a9a2fc11a58"><code>jevois::rawimage::drawCircle</code></a>関数を呼び出しています。</p>
<p>プログラムが書ければ、再度ビルドして実行します。</p>
<div class="highlight"><pre><span></span>$ ./rebuild-platform.sh --live
$ guvcview
</pre></div>


<p>実行の結果、JeVoisでコーナー検出ができました。</p>
<p><img alt="20200109_screenshot1.png" src="images/20200109_screenshot1.png"></p>
    </article>

        <div class="tags">
            <p>tags: <a href="./tag/etsuzikonpiyuteingu.html">エッジコンピューティング</a>, <a href="./tag/hua-xiang-chu-li.html">画像処理</a>, <a href="./tag/jevois.html">JeVois</a></p>
        </div>

    <hr>

        <div class="comments">
            <h5>コメント</h5>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'whitepaper-tech-blog';
                var disqus_identifier = 'JeVois-Tutorial-2.html';
                var disqus_url = 'https://tech.wpaper-inc.com/JeVois-Tutorial-2.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//whitepaper-tech-blog.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-you can add links in your config file fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-another social link fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>. <br />        &copy;  Whitepaper Inc.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="./theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="./theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="./theme/js/clean-blog.min.js"></script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-122761088-2', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    var disqus_shortname = 'whitepaper-tech-blog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>